


<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta http-equiv="Content-Language" content="ar">
  <title>
    
      Fixing Sinatra UTF-8 issue in Tilt rendered templates &middot; Abdullah Barrak's Blog
    
  </title>
  <!-- CSS -->
  
  <link rel="stylesheet" href="/public/all.min.css">
  
  <!-- Fonts -->
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/icons/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/icons/favicon.ico">
  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

<body class="theme-base-08 ">
  <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A passionate blog about computer programming, reading, thinking, and the like.
</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">
      Home
    </a>
    
    
      
        
      
    
      
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">
          About
          </a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/works/">
          Works
          </a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/code/">
          Code
          </a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/contact/">
          Contact
          </a>
        
      
    
  </nav>

  <div class="sidebar-item">
    <b>language</b>
    <div class="center">
      <a style="font-weight: bold;" href="/">English</a> &nbsp; | &nbsp;
      <a style="font-weight: bold;" href="/ar/">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</a>
    </div>
  </div>

  <div class=" sidebar-nav-item social-icon">
    <a href="https://twitter.com/abarrak_" rel="nofollow" target="_blank">
    <img src="/public/icons/twitter-icon.png" alt="Twitter Icon">
    </a>
    <a href="https://www.linkedin.com/in/abarrak" rel="nofollow" target="_blank">
    <img src="/public/icons/linkedin-icon.png" alt="LinkedIn Icon">
    </a>
    <a href="https://www.goodreads.com/abarrak" rel="nofollow" target="_blank">
      <img src="/public/icons/goodreads-icon.png" alt="Goodreads Icon">
    </a>
    <a href="https://github.com/abarrak" rel="nofollow" target="_blank">
      <img src="/public/icons/github-icon.png" alt="Github Icon">
    </a>
  </div>

  <div class="sidebar-item center">
    <p>
      abarrak.com (2016).
    </p>
  </div>
</div>


  <div class="wrap">
    <div class="masthead">
      <div class="container">
        <h3 class="masthead-title">
          <a href="/" title="Home">Abdullah Barrak's</a>
          <small>Blog</small>
        </h3>
      </div>
    </div>

    <div class="container content">
      

<div class="post">
  <div class="post-heading">
    <h1 class="post-title">Fixing Sinatra UTF-8 issue in Tilt rendered templates</h1>
    
      <span class="post-date">26 Aug 2016</span>
    
  </div>
  <p><img src="/public/images/sinatra-logo.png" class="post-image resize-40 center-image"></p>

<p>In the past week, I‚Äôv been woking with Sinatra app deployment to AWS Elastic Beanstalk. In development environment everything was working just fine, but when I published the application and tested it in production, I encountered a weird problem in one of the templates that was suppose to be supporting uft-8 text without issues.</p>

<h3 id="symptoms"><strong>Symptoms</strong></h3>
<p>The error was appearing in one of the <code class="highlighter-rouge">.erb</code> view files that contains a <code class="highlighter-rouge">textarea</code> field. When non English text is populated in it at the server, the application crashes with 500 code. Here‚Äôs a fragment of the error stack trace:</p>

<!-- post-excerpt -->

<div class="language-sh highlighter-rouge">
<pre class="highlight"><code>2016-08-26 19:15:53 - Encoding::CompatibilityError - incompatible character encodings: UTF-8 and US-ASCII:
        /var/app/current/views/review.erb:69:in <span class="sb">`</span>block <span class="k">in </span>singleton class<span class="s1">'
        /var/app/current/views/review.erb:-7:in `instance_eval'</span>
        /var/app/current/views/review.erb:-7:in <span class="sb">`</span>singleton class<span class="s1">'
        /var/app/current/views/review.erb:-9:in `__tilt_47353692136320'</span>
        /opt/rubies/ruby-2.2.5/lib/ruby/gems/2.2.0/gems/tilt-2.0.5/lib/tilt/template.rb:167:in <span class="sb">`</span>call<span class="s1">'
        /opt/rubies/ruby-2.2.5/lib/ruby/gems/2.2.0/gems/tilt-2.0.5/lib/tilt/template.rb:167:in `evaluate'</span>
        /opt/rubies/ruby-2.2.5/lib/ruby/gems/2.2.0/gems/tilt-2.0.5/lib/tilt/template.rb:102:in <span class="sb">`</span>render<span class="s1">'
        /opt/rubies/ruby-2.2.5/lib/ruby/gems/2.2.0/gems/sinatra-1.4.7/lib/sinatra/base.rb:823:in `render'</span>
        /opt/rubies/ruby-2.2.5/lib/ruby/gems/2.2.0/gems/sinatra-1.4.7/lib/sinatra/base.rb:667:in <span class="sb">`</span>erb<span class="s1">'
        /var/app/current/helpers.rb:24:in `block (2 levels) in serve_page'</span>
</code></pre>
</div>
<p>Guided by the error message indication. I attempted to fix the issue by ensuring that all parts are encoded as UTF-8. I set <code class="highlighter-rouge">accept-charset</code> attribute for the form and texteara tag to <code class="highlighter-rouge">"UTF-8"</code>, forced source files to be UTF-8 by inserting <code class="highlighter-rouge"># üòÅ</code> comment, and checked the Sinatra routing is also set to have
<code class="highlighter-rouge">headers 'Content-type' =&gt; 'text/html; charset=utf-8'</code>, But unfortunately none of that was solving the problem.</p>

<p>By taking closer look at the stack trace, I figured that it was happening specifically during the template rendering phase, and might have something to do with Sinatra‚Äôs Tilt library.</p>

<h3 id="solution"><strong>Solution</strong></h3>

<p>Indeed it was caused by Tilt . In fact, it‚Äôs a known issue and has been pointed out in the gem‚Äôs <a href="https://github.com/rtomayko/tilt#encodings" rel="nofollow" target="_blank">repository main page</a>.
Setting ruby‚Äôs external encoding plus the source files to <code class="highlighter-rouge">UTF-8</code> solved it for me just like mentioned in the link.</p>

<p>If you‚Äôve structured your app in the modular style, then set encoding early in the class.</p>

<div class="language-rb highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MyApplication</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
  <span class="c1"># set encoding.</span>
  <span class="no">Encoding</span><span class="p">.</span><span class="nf">default_external</span> <span class="o">=</span> <span class="s2">"UTF-8"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>In classic applications, this would suffice.</p>

<div class="language-rb highlighter-rouge">
<pre class="highlight"><code><span class="no">Encoding</span><span class="p">.</span><span class="nf">default_external</span> <span class="o">=</span> <span class="s2">"UTF-8"</span>
</code></pre>
</div>

<p>That‚Äôs it. Hope It helps someone else !</p>

</div>


<h2 class="comments-label">Comments</h2>
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
      this.page.url = "http://abarrak.com/2016/08/26/fix-sinatra-tilt-unicode";
      this.page.identifier = "fixing-sinatra-utf-8-issue-in-tilt-rendered-templates";
  };

  (function() {
      var d = document, s = d.createElement('script');
      s.src = '//abarrak.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>
  Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow" target="_blank">comments powered by Disqus.</a>
</noscript>




    </div>
  </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
  
  <script src="/public/all.min.js"></script>
  

  
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-83251901-1', 'auto');
    ga('send', 'pageview');
  </script>
  

</body>
</html>
